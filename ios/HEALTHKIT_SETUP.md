# HealthKit Setup для iOS приложения

## Шаг 1: Включить HealthKit Capability

1. Открой проект в Xcode
2. Выбери Target **HealthHub**
3. Перейди на вкладку **Signing & Capabilities**
4. Нажми **+ Capability**
5. Найди и добавь **HealthKit**

## Шаг 1.1: Включить Sign in with Apple Capability

1. Открой Target **HealthHub**
2. Перейди на вкладку **Signing & Capabilities**
3. Нажми **+ Capability**
4. Добавь **Sign In with Apple**

Важно:
- Для SIWA не нужен отдельный `Info.plist` usage string (в отличие от HealthKit).
- На симуляторе поведение может отличаться; стабильнее тестировать на реальном устройстве.

## Шаг 2: Добавить Privacy Descriptions в Info.plist

1. Открой файл `Info.plist` в Xcode (или через контекстное меню: Open As → Source Code)

2. Добавь следующие ключи:

```xml
<key>NSHealthShareUsageDescription</key>
<string>Приложение использует данные здоровья для отслеживания активности, пульса и веса, чтобы показывать вам статистику и предлагать рекомендации</string>

<key>NSHealthUpdateUsageDescription</key>
<string>Приложение может записывать данные здоровья (зарезервировано для будущих функций)</string>
```

**Важно**: `NSHealthShareUsageDescription` обязателен для чтения данных из HealthKit.

## Шаг 3: Типы данных, которые читает приложение

Приложение запрашивает доступ к следующим типам данных:

- **Steps (Шаги)** — `HKQuantityTypeIdentifier.stepCount`
- **Heart Rate (Пульс)** — `HKQuantityTypeIdentifier.heartRate`
- **Resting Heart Rate (Пульс в покое)** — `HKQuantityTypeIdentifier.restingHeartRate`
- **Body Mass (Вес)** — `HKQuantityTypeIdentifier.bodyMass`

## Шаг 4: Проверка на реальном устройстве

### Симулятор

⚠️ **HealthKit на симуляторе сильно ограничен**:
- Нет реальных данных шагов/пульса
- Можно добавлять данные вручную через приложение Health
- Авторизация работает, но данные часто пустые

### Реальное устройство (рекомендуется)

✅ **На реальном iPhone/Apple Watch**:
1. Убедись что устройство авторизовано для разработки
2. Запусти приложение (Cmd+R)
3. В приложении нажми **"Запросить доступ к Health"**
4. iOS покажет системный диалог с выбором типов данных
5. Разреши доступ ко всем типам (Steps, Heart Rate, Resting HR, Weight)
6. Нажми **"Sync Today (HealthKit)"** или **"Sync Last 7 Days (HealthKit)"**

## Шаг 5: Тестирование

### Проверка доступа

После запроса доступа должен появиться статус:
```
✅ Доступ разрешён
```

### Синхронизация данных

1. Нажми **"Sync Today (HealthKit)"**
   - Отправляет данные за сегодня (шаги, пульс, вес)
   - Почасовые бакеты для шагов и пульса

2. Нажми **"Sync Last 7 Days (HealthKit)"**
   - Отправляет данные за последние 7 дней
   - Дневные агрегаты + почасовые бакеты за каждый день

3. После синхронизации нажми:
   - **"Загрузить дневные метрики"** — проверяем что данные сохранились на сервере
   - **"Загрузить часовые HR"** — проверяем часовые данные пульса

### Ожидаемые данные

**На реальном устройстве с Apple Watch**:
- Шаги: обычно есть данные за сегодня и предыдущие дни
- Пульс: есть если носите Apple Watch (измеряется регулярно)
- Resting HR: может быть доступен если Apple Watch измерял
- Вес: есть только если вводили вручную в Health или используете smart весы

**В симуляторе**:
- Большинство данных будут пустыми
- Можно вручную добавить данные через приложение Health

## Шаг 6: Добавление тестовых данных (симулятор)

Если тестируешь в симуляторе:

1. Открой приложение **Health** (стандартное iOS)
2. Browse → Activity → Steps
3. Нажми "Add Data" → укажи дату, время и количество шагов
4. Аналогично для Heart Rate, Weight
5. Вернись в HealthHub и запусти синхронизацию

## Шаг 7: Отладка проблем

### Ошибка "HealthKit недоступен на этом устройстве"

- HealthKit не работает на iPad
- Убедись что тестируешь на iPhone

### Ошибка "Не удалось получить разрешение"

- Проверь что добавлен `NSHealthShareUsageDescription` в Info.plist
- Проверь что HealthKit capability включен

### Пустые данные после синхронизации

- Проверь разрешения в Settings → Health → Data Access → HealthHub
- Убедись что все типы данных разрешены
- Проверь что есть данные в приложении Health за нужный период

### Ошибка при синхронизации

- Убедись что backend сервер запущен (`go run ./cmd/api`)
- Проверь что сервер доступен на `http://localhost:8080`
- Посмотри логи сервера на наличие ошибок

## Структура данных

### Daily Aggregate (дневные данные)

```json
{
  "date": "2026-02-12",
  "activity": {
    "steps": 10000,
    "active_energy_kcal": 0,
    "exercise_min": 0,
    "stand_hours": 0,
    "distance_km": 0
  },
  "heart": {
    "resting_hr_bpm": 65
  },
  "body": {
    "weight_kg_last": 75.5,
    "bmi": 0
  }
}
```

### Hourly Buckets (почасовые данные)

```json
{
  "hour": "2026-02-12T10:00:00Z",
  "steps": 1500,
  "hr": {
    "min": 60,
    "max": 85,
    "avg": 72
  }
}
```

## Фоновая синхронизация

Теперь background delivery и observer queries реализованы.

Пошаговая настройка и тестирование:
- `ios/BACKGROUND_SYNC.md`

---

**Рекомендация**: Всегда тестируй HealthKit функционал на **реальном устройстве** с данными из Apple Health.
